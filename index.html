    
<style>

  path {
    stroke:white;
    stroke-width: 0.5px;
  }

  body {
    font-family: Arial, sans-serif;
  }

  .appl {
    font: 10px sans-serif;
    font-weight: bold;
  }

  .legend {
    font-size: 12px;
  }

  div.tooltip {   
    position: absolute;           
    text-align: center;           
    width: 150px;                  
    height: 25px;                 
    padding: 2px;             
    font-size: 10px;     
    background: #FFFFE0;
    border: 1px;      
    border-radius: 8px;           
    pointer-events: none;         
  } 

  .feature {
      fill: #adfcad;
      /*opacity: 1;*/
  } 

  .feature.active {
      /*fill: orange;*/
      opacity: 1;
  } 

</style>

<!-- <script type="text/javascript" src="js/d3.v3.js"></script> -->
<script type="text/javascript" src="js/d3.v4.js"></script>
<script type="text/javascript" src="js/queue.v1.min.js"></script>
<script type="text/javascript" src="js/topojson.v2.min.js"></script>

<body>
</body>

<script type="text/javascript">


  var region_fpd = [{"region_id": "89", "count": 1747, "fpd": 0.1522610188895249}, {"region_id": "86", "count": 7293, "fpd": 0.16796928561634444}, {"region_id": "83", "count": 42, "fpd": 0.14285714285714285}, {"region_id": "79", "count": 210, "fpd": 0.19047619047619047}, {"region_id": "78", "count": 49128, "fpd": 0.10704689789936492}, {"region_id": "77", "count": 125349, "fpd": 0.09529393932141461}, {"region_id": "76", "count": 2921, "fpd": 0.17767887709688462}, {"region_id": "75", "count": 1407, "fpd": 0.21677327647476902}, {"region_id": "74", "count": 13599, "fpd": 0.14030443414956983}, {"region_id": "73", "count": 3636, "fpd": 0.13861386138613863}, {"region_id": "72", "count": 14800, "fpd": 0.08385135135135136}, {"region_id": "71", "count": 10226, "fpd": 0.0884999022100528}, {"region_id": "70", "count": 1760, "fpd": 0.22272727272727272}, {"region_id": "69", "count": 5346, "fpd": 0.1017583239805462}, {"region_id": "68", "count": 1073, "fpd": 0.20503261882572227}, {"region_id": "67", "count": 1254, "fpd": 0.21212121212121213}, {"region_id": "66", "count": 31949, "fpd": 0.10964349431907101}, {"region_id": "65", "count": 952, "fpd": 0.15021008403361344}, {"region_id": "64", "count": 10549, "fpd": 0.1145132240022751}, {"region_id": "63", "count": 22145, "fpd": 0.09243621585007902}, {"region_id": "62", "count": 7345, "fpd": 0.08141592920353982}, {"region_id": "61", "count": 16693, "fpd": 0.11328101599472833}, {"region_id": "60", "count": 3158, "fpd": 0.13362887903736542}, {"region_id": "59", "count": 17648, "fpd": 0.11066409791477788}, {"region_id": "58", "count": 2623, "fpd": 0.15478459778879147}, {"region_id": "57", "count": 1034, "fpd": 0.17891682785299806}, {"region_id": "56", "count": 15757, "fpd": 0.055023164307926635}, {"region_id": "55", "count": 4670, "fpd": 0.1366167023554604}, {"region_id": "54", "count": 18764, "fpd": 0.11133020677893839}, {"region_id": "53", "count": 3166, "fpd": 0.11939355653821858}, {"region_id": "52", "count": 18236, "fpd": 0.09903487606931345}, {"region_id": "51", "count": 2305, "fpd": 0.19739696312364424}, {"region_id": "50", "count": 75686, "fpd": 0.09966176043125545}, {"region_id": "49", "count": 298, "fpd": 0.19463087248322147}, {"region_id": "48", "count": 3552, "fpd": 0.1188063063063063}, {"region_id": "47", "count": 4704, "fpd": 0.13754251700680273}, {"region_id": "46", "count": 2089, "fpd": 0.15461943513642892}, {"region_id": "45", "count": 1098, "fpd": 0.22859744990892533}, {"region_id": "44", "count": 687, "fpd": 0.21397379912663755}, {"region_id": "43", "count": 2997, "fpd": 0.11845178511845178}, {"region_id": "42", "count": 5748, "fpd": 0.21520528879610298}, {"region_id": "40", "count": 5007, "fpd": 0.12123027761134411}, {"region_id": "39", "count": 2221, "fpd": 0.17379558757316524}, {"region_id": "38", "count": 4789, "fpd": 0.18960116934641888}, {"region_id": "37", "count": 3552, "fpd": 0.11204954954954954}, {"region_id": "36", "count": 11329, "fpd": 0.08932827257480802}, {"region_id": "35", "count": 1998, "fpd": 0.1941941941941942}, {"region_id": "34", "count": 9392, "fpd": 0.11541737649063033}, {"region_id": "33", "count": 5170, "fpd": 0.12785299806576403}, {"region_id": "32", "count": 3703, "fpd": 0.13097488522819337}, {"region_id": "31", "count": 8336, "fpd": 0.10592610364683301}, {"region_id": "30", "count": 2303, "fpd": 0.16456795484151107}, {"region_id": "29", "count": 5138, "fpd": 0.10665628649279875}, {"region_id": "28", "count": 1138, "fpd": 0.22407732864674867}, {"region_id": "27", "count": 2921, "fpd": 0.19753509072235537}, {"region_id": "26", "count": 10774, "fpd": 0.10618154817152405}, {"region_id": "25", "count": 3740, "fpd": 0.19491978609625668}, {"region_id": "24", "count": 7805, "fpd": 0.17911595131326072}, {"region_id": "23", "count": 26536, "fpd": 0.12077931866144107}, {"region_id": "22", "count": 5901, "fpd": 0.1682765632943569}, {"region_id": "21", "count": 4700, "fpd": 0.08042553191489361}, {"region_id": "19", "count": 822, "fpd": 0.20924574209245742}, {"region_id": "18", "count": 4496, "fpd": 0.13367437722419928}, {"region_id": "17", "count": 1843, "fpd": 0.21052631578947367}, {"region_id": "16", "count": 22000, "fpd": 0.08736363636363637}, {"region_id": "14", "count": 2353, "fpd": 0.18147046323841903}, {"region_id": "13", "count": 899, "fpd": 0.19132369299221358}, {"region_id": "12", "count": 3185, "fpd": 0.08100470957613815}, {"region_id": "11", "count": 2045, "fpd": 0.16381418092909536}, {"region_id": "10", "count": 1017, "fpd": 0.21140609636184857}, {"region_id": "09", "count": 1, "fpd": 0.0}, {"region_id": "08", "count": 316, "fpd": 0.21835443037974683}, {"region_id": "07", "count": 2, "fpd": 0.0}, {"region_id": "04", "count": 443, "fpd": 0.21218961625282168}, {"region_id": "03", "count": 1175, "fpd": 0.17617021276595746}, {"region_id": "02", "count": 12944, "fpd": 0.11233003708281829}, {"region_id": "01", "count": 1, "fpd": 0.0}];

  // ---------------------------------

  var width = 1860, height = 900;
  var active = d3.select(null)

  var formatFloat = d3.format(".3f");
 
  // Setting color domains(intervals of values) for our map
  var color_domain = [0.05, 0.1, 0.15, 0.2, 0.25]
  var ext_color_domain = [0, 0.05, 0.1, 0.15, 0.2, 0.25]
  var legend_labels = ["< 0.05", "0.05 - 0.1", "0.1 - 0.15", "0.15 - 0.2", "0.2 - 0.25", "> 0.25"]              
  var color = d3.scaleThreshold()//d3.scaleOrdinal()
  .domain(color_domain).range(["#adfcad", "#ffcb40", "#ffba00", "#ff7d73", "#ff4e40", "#ff1300"]);

  var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);



  //------ Map zooming -------
  var zoom = d3.zoom()
    .scaleExtent([0, 20])
    .translateExtent([[0, 0], [width, height]])
    .extent([[0, 0], [width, height]])
    .on("zoom", function() {

        // total transform
        g.attr("transform", d3.event.transform);

        // transfrom markes
        g.selectAll("circle")
          .attr("r", function() {    
            var r = 3 / d3.event.transform.k;
            // var obj = d3.select(this);
            // obj.style("stroke-width", r < 4 ? (r < 2 ? 0.5 : 1) : 2);
            return r;
        });

        // transform boundaries
        g.selectAll("path.feature")
          .style("stroke-width", function() {    
            var w = 0.5 / (d3.event.transform.k * 0.5);
            // var obj = d3.select(this);
            // obj.style("stroke-width", r < 4 ? (r < 2 ? 0.5 : 1) : 2);
            return w + 'px';
        });


  });

  //-------------
  var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .style("margin", "10px auto")
    .call(zoom)
    .on("click", stopped, true);

  var g = svg.append("g");

  var projection = d3.geoAlbers()
    .rotate([-100, 0])
    .center([-10, 65])
    .parallels([52, 64])
    .scale(1100)
    .translate([width / 2, height / 2])
    .precision(.1)
    ;

  var path = d3.geoPath().projection(projection);

  //Reading map file and data
  queue()
    // .defer(d3.json, "{% static 'map/russia_1e-7sr.json' %}") // regions boundaries
    .defer(d3.json, "map/russia_2015.json") // regions boundaries
    .defer(d3.csv, "map/offices.csv")

    .await(load_data);

  //Start of Choropleth drawing
    var rateById = {};
    var nameById = {};

    region_fpd.forEach(function(d) {
      rateById[d.region_id + '_fpd'] = formatFloat(d.fpd);
      rateById[d.region_id + '_count'] = d.count;

    });

  // console.log(rateById);


  function load_data(error, map, offices) {

    if (error) throw error;

    offices.forEach(function(d) {
      d.city = d.city;
      d.address = d.address;
    });


  //Drawing map

  g.selectAll("path")
    .data(topojson.feature(map, map.objects.russia).features) //<-- in case topojson.v1.js
    .enter().append("path")
    .attr("d", path)
    .attr("class", "feature")
    .style("fill", function(d) {
      return color(rateById[d.properties.region_id.substr(0, 2) + '_fpd']); 
    })
    .style("opacity", 0.6)
    //Adding mouseevents
    .on("mouseover", function(d) {
        d3.select(this).transition().duration(300).style("opacity", 1);
        div.transition().duration(100)
        .style("opacity", 1)
        var fpd_value = (rateById[d.properties.region_id.substr(0, 2) + '_fpd'] === undefined) ? 0 : rateById[d.properties.region_id.substr(0, 2)+ '_fpd'];
        var count_value = (rateById[d.properties.region_id.substr(0, 2) + '_count'] === undefined) ? 0 : rateById[d.properties.region_id.substr(0, 2) + '_count'];
        div.text(d.properties.region_name + ' fpd: ' + fpd_value + ', count: ' + count_value)
        .style("left", (d3.event.pageX) + "px")
        .style("top", (d3.event.pageY -30) + "px");

    })
    .on("mouseout", function() {
        d3.select(this)
        .transition().duration(300)
        .style("opacity", 0.6);
        div.transition().duration(300)
        .style("opacity", 0);
    })
    .on("click", clicked)
    ;
  
    // Adding cities on the map
    var office = g.selectAll("office")
      .data(offices)
      .enter()
      .append("g")
      .attr("class", "office")
      .attr("transform", function(d) { return "translate(" + projection([d.lon, d.lat]) + ")"; });

    office.append("circle")
      .attr("r", 3)
      .style("fill", "blue")
      .style("opacity", 1)
      .on("mouseover", function(d) { 
        d3.select('text.text_' + d.city.replace(" ", '_') + '_' + d.district.replace(" ", '_')).style("display", 'block');})
      .on("mouseout", function(d) {
          d3.select('text.text_' + d.city.replace(" ", '_') + '_' + d.district.replace(" ", '_')).style("display", 'none');
        })
      ;

    office.append("text")
      .attr("x", 2)
      .attr('class', function(d) { return 'text_marker text_' + d.city.replace(" ", '_') + '_' + d.district.replace(" ", '_');})
      .text(function(d) { return d.city + ' (' + d.address + ')';})
      .style('display', 'none')
      ;




  }; // <-- End of map drawing

  //Adding legend for our Choropleth

  var legend = svg.selectAll("g.legend")
    .data(ext_color_domain)
    .enter().append("g")
    .attr("class", "legend");

  var ls_w = 20, ls_h = 20;

  legend.append("rect")
    .attr("x", 20)
    .attr("y", function(d, i){ return height/1.3 - (i*ls_h) - 2*ls_h;})
    .attr("width", ls_w)
    .attr("height", ls_h)
    .style("fill", function(d, i) { return color(d); })
    .style("opacity", 0.8);

  legend.append("text")
    .attr("x", 50)
    .attr("y", function(d, i){ return height/1.3 - (i*ls_h) - ls_h - 4;})
    .text(function(d, i){ return legend_labels[i]; });

  
  function clicked(d) {
    if (active.node() === this) return reset();
    active.classed("active", false);
    active = d3.select(this).classed("active", true);

    var bounds = path.bounds(d),
        dx = bounds[1][0] - bounds[0][0],
        dy = bounds[1][1] - bounds[0][1],
        x = (bounds[0][0] + bounds[1][0]) / 2,
        y = (bounds[0][1] + bounds[1][1]) / 2,
        scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height))),
        translate = [width / 2 - scale * x, height / 2 - scale * y];

    svg.transition()
        .duration(750)
        .call( zoom.transform, d3.zoomIdentity.translate(translate[0],translate[1]).scale(scale) );
  }

  function reset() {
    active.classed("active", false);
    active = d3.select(null);

    svg.transition()
        .duration(750)
        .call( zoom.transform, d3.zoomIdentity );
  }

  function zoomed() {
    g.style("stroke-width", 1.5 / d3.event.transform.k + "px");
    g.attr("transform", d3.event.transform);

  }

  // If the drag behavior prevents the default click,
  // also stop propagation so we don’t click-to-zoom.
  function stopped() {
    if (d3.event.defaultPrevented) d3.event.stopPropagation();
  }


  function collide() {
    node = this.node();
    nodeBox = node.getBBox();
    nodeLeft = nodeBox.x;
    nodeRight = nodeBox.x + nodeBox.width;
    nodeTop = nodeBox.y;
    nodeBottom = nodeBox.y + nodeBox.height;

    d3.selectAll("circle")
      .attr("fill", function() {
        if (this !== node) {
          otherBox = this.getBBox();
          
          otherLeft = otherBox.x;
          otherRight = otherBox.x + otherBox.width;
          otherTop = otherBox.y;
          otherBottom = otherBox.y + otherBox.height;
          
          collideHoriz = nodeLeft < otherRight && nodeRight > otherLeft;
          collideVert = nodeTop < otherBottom && nodeBottom > otherTop;
          
          if ( collideHoriz && collideVert) {
            return "tomato";
          } else {
            return "none"
          }
          
        } else {
          return "none";
        }
      });
  }


</script>
